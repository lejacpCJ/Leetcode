from typing import List
from functools import lru_cache

class Solution:
    def lenOfVDiagonal(self, grid: List[List[int]]) -> int:
        n, m = len(grid), len(grid[0])
        # Diagonal directions: ↘, ↙, ↖, ↗ (clockwise order)
        dirs = [(1,1), (1,-1), (-1,-1), (-1,1)]

        @lru_cache(maxsize=None)
        def dp(x, y, d, turn, prev):
            if not (0 <= x < n and 0 <= y < m):
                return 0
            # Sequence rule
            if prev == 1 or prev == 0:
                expected = 2
            else:  # prev == 2
                expected = 0
            if grid[x][y] != expected:
                return 0
            res = 1
            # Continue in same direction
            nx, ny = x + dirs[d][0], y + dirs[d][1]
            res = max(res, 1 + dp(nx, ny, d, turn, grid[x][y]))
            # Try turning if not turned yet
            if turn == 0:
                nd = (d + 1) % 4  # 90-degree clockwise
                nx2, ny2 = x + dirs[nd][0], y + dirs[nd][1]
                res = max(res, 1 + dp(nx2, ny2, nd, 1, grid[x][y]))
            return res

        ans = 0
        for i in range(n):
            for j in range(m):
                if grid[i][j] == 1:
                    for d in range(4):
                        nx, ny = i + dirs[d][0], j + dirs[d][1]
                        ans = max(ans, 1 + dp(nx, ny, d, 0, 1))
        return ans